---------------------------------------------------------
-- 1. SECCIÓN DE BORRADO (LIMPIEZA)
-- Se usa CASCADE CONSTRAINTS para romper relaciones al borrar
---------------------------------------------------------
DROP TABLE pelea CASCADE CONSTRAINTS;
DROP TABLE ranking_libra_libra CASCADE CONSTRAINTS;
DROP TABLE ranking_categoria CASCADE CONSTRAINTS;
DROP TABLE peleador_auditoria CASCADE CONSTRAINTS;
DROP TABLE evento_auditoria CASCADE CONSTRAINTS;
DROP TABLE peleador CASCADE CONSTRAINTS;
DROP TABLE evento CASCADE CONSTRAINTS;
DROP TABLE categoria_peso CASCADE CONSTRAINTS;
DROP TABLE estilo_combate CASCADE CONSTRAINTS;

-- Opcional: Eliminar tabla antigua si existiera
DROP TABLE peleador_estilo CASCADE CONSTRAINTS;

---------------------------------------------------------
-- 2. SECCIÓN DE CREACIÓN (Oracle Syntax Corregida)
---------------------------------------------------------

-- Tabla de categorías de peso
CREATE TABLE categoria_peso (
    id_categoria    NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    nombre          VARCHAR2(50) NOT NULL,
    limite_inferior NUMBER(5,2),
    limite_superior NUMBER(5,2)
);

-- Tabla de estilos de combate
CREATE TABLE estilo_combate (
    id_estilo   NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    nombre      VARCHAR2(50) NOT NULL UNIQUE
);

-- Tabla de peleadores
CREATE TABLE peleador (
    id_peleador     NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    nombre          VARCHAR2(100) NOT NULL,
    apodo           VARCHAR2(50),
    edad            NUMBER,
    nacionalidad    VARCHAR2(50),
    id_categoria    NUMBER NOT NULL,
    id_estilo       NUMBER NOT NULL,
    victorias       NUMBER DEFAULT 0,
    derrotas        NUMBER DEFAULT 0,
    empates         NUMBER DEFAULT 0,
    
    CONSTRAINT chk_record CHECK (victorias >= 0 AND derrotas >= 0 AND empates >= 0),
    
    CONSTRAINT fk_categoria FOREIGN KEY (id_categoria)
        REFERENCES categoria_peso(id_categoria),
        
    CONSTRAINT fk_peleador_estilo_base FOREIGN KEY (id_estilo)
        REFERENCES estilo_combate(id_estilo)
);

-- Tabla de eventos
CREATE TABLE evento (
    id_evento       NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    nombre          VARCHAR2(100) NOT NULL,
    fecha           DATE NOT NULL,
    lugar           VARCHAR2(100),
    entradas_vendidas NUMBER,
    precio_entrada    NUMBER
);

-- Tabla de peleas
CREATE TABLE pelea (
    id_pelea        NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    id_evento       NUMBER NOT NULL,
    id_peleador1    NUMBER NOT NULL,
    id_peleador2    NUMBER NOT NULL,
    resultado       VARCHAR2(50), 
    ganador         NUMBER,        
    
    CONSTRAINT fk_pelea_evento FOREIGN KEY (id_evento)
        REFERENCES evento(id_evento),
    CONSTRAINT fk_pelea_peleador1 FOREIGN KEY (id_peleador1)
        REFERENCES peleador(id_peleador),
    CONSTRAINT fk_pelea_peleador2 FOREIGN KEY (id_peleador2)
        REFERENCES peleador(id_peleador),
    CONSTRAINT fk_pelea_ganador FOREIGN KEY (ganador)
        REFERENCES peleador(id_peleador),
    CONSTRAINT chk_pelea_distintos CHECK (id_peleador1 <> id_peleador2)
);

-- Tabla de ranking libra por libra
CREATE TABLE ranking_libra_libra (
    id_ranking   NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    id_peleador  NUMBER NOT NULL,
    posicion     NUMBER NOT NULL,
    fecha        TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    CONSTRAINT fk_ranking_peleador FOREIGN KEY (id_peleador)
        REFERENCES peleador(id_peleador),
    CONSTRAINT uq_ranking UNIQUE (posicion, fecha)
);

-- Ranking por categoría de peso
CREATE TABLE ranking_categoria (
    id_ranking      NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    id_categoria    NUMBER NOT NULL,
    id_peleador     NUMBER NOT NULL,
    posicion        NUMBER NOT NULL, 
    fecha           TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    CONSTRAINT fk_rankcat_categoria FOREIGN KEY (id_categoria)
        REFERENCES categoria_peso(id_categoria),
    CONSTRAINT fk_rankcat_peleador FOREIGN KEY (id_peleador)
        REFERENCES peleador(id_peleador),
    CONSTRAINT uq_rankcat UNIQUE (id_categoria, posicion, fecha),
    CONSTRAINT chk_rankcat_pos CHECK (posicion BETWEEN 1 AND 15)
);

-- Tablas de Auditoría
CREATE TABLE peleador_auditoria (
    id_auditoria    NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    id_peleador     NUMBER,
    nombre          VARCHAR2(100),
    apodo           VARCHAR2(50),
    edad            NUMBER,
    nacionalidad    VARCHAR2(50),
    id_categoria    NUMBER,
    id_estilo       NUMBER, 
    victorias       NUMBER,
    derrotas        NUMBER,
    empates         NUMBER,
    fecha_auditoria TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    tipo_modificacion VARCHAR2(20) DEFAULT 'sin especificar'
);

CREATE TABLE evento_auditoria (
    id_auditoria      NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    id_evento         NUMBER,
    nombre            VARCHAR2(100),
    fecha             DATE,
    lugar             VARCHAR2(100),
    entradas_vendidas NUMBER,
    precio_entrada    NUMBER,
    fecha_auditoria   TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    tipo_modificacion VARCHAR2(20) DEFAULT 'sin especificar'
);




