-- Tabla de categorías de peso
CREATE TABLE categoria_peso (
    id_categoria    INT AUTO_INCREMENT PRIMARY KEY,
    nombre          VARCHAR(50) NOT NULL,
    limite_inferior DECIMAL(5,2), -- DECIMAL es el equivalente a NUMBER con decimales
    limite_superior DECIMAL(5,2)
);

-- Tabla de estilos de combate
CREATE TABLE estilo_combate (
    id_estilo   INT AUTO_INCREMENT PRIMARY KEY,
    nombre      VARCHAR(50) NOT NULL UNIQUE
);

-- Tabla de peleadores
CREATE TABLE peleador (
    id_peleador     INT AUTO_INCREMENT PRIMARY KEY,
    nombre          VARCHAR(100) NOT NULL,
    apodo           VARCHAR(50),
    edad            INT,
    nacionalidad    VARCHAR(50),
    id_categoria    INT NOT NULL,
    victorias       INT DEFAULT 0,
    derrotas        INT DEFAULT 0,
    empates         INT DEFAULT 0,
    CHECK (victorias >= 0 AND derrotas >= 0 AND empates >= 0),
    CONSTRAINT fk_categoria FOREIGN KEY (id_categoria)
        REFERENCES categoria_peso(id_categoria)
);

-- Relación N:M entre peleadores y estilos de combate
CREATE TABLE peleador_estilo (
    id_peleador INT NOT NULL,
    id_estilo   INT NOT NULL,
    PRIMARY KEY (id_peleador, id_estilo),
    CONSTRAINT fk_pelea_estilo_peleador FOREIGN KEY (id_peleador)
        REFERENCES peleador(id_peleador),
    CONSTRAINT fk_pelea_estilo_estilo FOREIGN KEY (id_estilo)
        REFERENCES estilo_combate(id_estilo)
);

-- Tabla de eventos
CREATE TABLE evento (
    id_evento   INT AUTO_INCREMENT PRIMARY KEY,
    nombre      VARCHAR(100) NOT NULL,
    fecha       DATE NOT NULL,
    lugar       VARCHAR(100)
);

-- Tabla de peleas
CREATE TABLE pelea (
    id_pelea       INT AUTO_INCREMENT PRIMARY KEY,
    id_evento      INT NOT NULL,
    id_peleador1   INT NOT NULL,
    id_peleador2   INT NOT NULL,
    resultado      VARCHAR(50), 
    ganador        INT,        
    CONSTRAINT fk_pelea_evento FOREIGN KEY (id_evento)
        REFERENCES evento(id_evento),
    CONSTRAINT fk_pelea_peleador1 FOREIGN KEY (id_peleador1)
        REFERENCES peleador(id_peleador),
    CONSTRAINT fk_pelea_peleador2 FOREIGN KEY (id_peleador2)
        REFERENCES peleador(id_peleador),
    CONSTRAINT fk_pelea_ganador FOREIGN KEY (ganador)
        REFERENCES peleador(id_peleador),
    CONSTRAINT chk_pelea_distintos CHECK (id_peleador1 <> id_peleador2)
);

-- Tabla de ranking libra por libra
CREATE TABLE ranking_libra_libra (
    id_ranking   INT AUTO_INCREMENT PRIMARY KEY,
    id_peleador  INT NOT NULL,
    posicion     INT NOT NULL,
    fecha        DATETIME DEFAULT CURRENT_TIMESTAMP, -- SYSDATE cambia a CURRENT_TIMESTAMP
    CONSTRAINT fk_ranking_peleador FOREIGN KEY (id_peleador)
        REFERENCES peleador(id_peleador),
    CONSTRAINT uq_ranking UNIQUE (posicion, fecha)
);

-- Ranking por categoría de peso
CREATE TABLE ranking_categoria (
    id_ranking     INT AUTO_INCREMENT PRIMARY KEY,
    id_categoria   INT NOT NULL,
    id_peleador    INT NOT NULL,
    posicion       INT NOT NULL, 
    fecha          DATETIME DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT fk_rankcat_categoria FOREIGN KEY (id_categoria)
        REFERENCES categoria_peso(id_categoria),
    CONSTRAINT fk_rankcat_peleador FOREIGN KEY (id_peleador)
        REFERENCES peleador(id_peleador),
    CONSTRAINT uq_rankcat UNIQUE (id_categoria, posicion, fecha),
    CONSTRAINT chk_rankcat_pos CHECK (posicion BETWEEN 1 AND 15)
);

-- Tabla de auditoría
CREATE TABLE peleador_auditoria (
    id_auditoria    INT AUTO_INCREMENT PRIMARY KEY,
    id_peleador     INT,
    nombre          VARCHAR(100),
    apodo           VARCHAR(50),
    edad            INT,
    nacionalidad    VARCHAR(50),
    id_categoria    INT,
    victorias       INT,
    derrotas        INT,
    empates         INT,
    fecha_auditoria DATETIME DEFAULT CURRENT_TIMESTAMP
);

-- ---------------------------------------------------------
-- Cambios en las tablas (ALTER TABLE corregidos)
-- ---------------------------------------------------------

-- En MySQL no se usan paréntesis para agrupar columnas en ADD, se repite ADD COLUMN
ALTER TABLE evento
ADD COLUMN entradas_vendidas INT,
ADD COLUMN precio_entrada INT;

ALTER TABLE peleador_auditoria
ADD COLUMN tipo_modificacion VARCHAR(20) DEFAULT 'sin especificar';

CREATE TABLE evento_auditoria (
    id_auditoria      INT AUTO_INCREMENT PRIMARY KEY,
    id_evento         INT,
    nombre            VARCHAR(100),
    fecha             DATE,
    lugar             VARCHAR(100),
    entradas_vendidas INT,
    precio_entrada    INT,
    fecha_auditoria   DATETIME DEFAULT CURRENT_TIMESTAMP,
    tipo_modificacion VARCHAR(20) DEFAULT 'sin especificar'
);
